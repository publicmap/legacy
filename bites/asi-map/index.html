<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <title>Cultural monuments of India</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <!--     Mapbox GL JS
     -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
    <!-- Turf -->
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <!-- Jquery -->
    <script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
    <!--     Table builder -->
    <script src='https://cdn.jsdelivr.net/gh/a-x-/table-builder/tablebuilder.js'></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      .mapboxgl-popup-content {
        max-width: 400px;
        max-height: 300px;
        overflow: scroll;
      }

    </style>
  </head>

  <body>

    <div id='map'></div>

    <script>
      var map = new mapboxgl.Map({
        container: 'map',
        style: 'https://cdn.jsdelivr.net/gh/mapbox/mapbox-gl-styles/styles/empty-v8.json',
        zoom: 4,
        center: [74.5447, 20.6892],
        hash: true
      });

      map.on('load', function() {

        map.addLayer({
          'id': 'osm-tiles',
          'type': 'raster',
          'source': {
            'type': 'raster',
            // Add OSM tiles: https://wiki.openstreetmap.org/wiki/Tile_servers
            'tiles': [
              'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'
            ],
            'tileSize': 256
          },
          'paint': {
            'raster-opacity': 0.4
          }
        });



map.addLayer({
                  'id': 'asi-monuments-areas',
                  'type': 'raster',
                  'source': {
                    'type': 'raster',
                    'tiles': ['https://publicmap-cors-anywhere.herokuapp.com/https://bhuvan5.nrsc.gov.in/bhuvan/asi/wms?STYLES=&LAYERS=asi:protected_areas&FORMAT=image/png&transparent=true&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&SRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=512&HEIGHT=512'],
                    'tileSize': 512,
                    'minzoom': 10
                  },
                  'paint': {}
                });

        map.addLayer({
          'id': 'asi-monuments',
          'type': 'raster',
          'source': {
            'type': 'raster',
            'tiles': ['https://publicmap-cors-anywhere.herokuapp.com/https://bhuvan5.nrsc.gov.in/bhuvan/asi/wms?STYLES=&LAYERS=asi:monuments2&FORMAT=image/png&transparent=true&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&SRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=512&HEIGHT=512'],
            'tileSize': 512
          },
          'paint': {}
        });



      });

      // Add  control to the map.
      var nav = new mapboxgl.NavigationControl();
      map.addControl(nav, 'top-left');

      map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: {
          enableHighAccuracy: true
        },
        trackUserLocation: true
      }));

      var scale = new mapboxgl.ScaleControl({
        maxWidth: 80,
        unit: 'metric'
      });
      map.addControl(scale);


      map.addControl(new mapboxgl.FullscreenControl());

      // When a click event occurs on a feature in the places layer, open a popup at the
      // location of the feature, with description HTML from its properties.
      map.on('click', function(e) {

        getFeatureInfo(map, e, {
          url: 'https://publicmap-cors-anywhere.herokuapp.com/https://bhuvan5.nrsc.gov.in/bhuvan/asi/wms',
          layer: 'asi:monuments2'
        });


      });

      function getFeatureInfo(map, clickEvent, WMSLayer) {

        let coordinates = clickEvent.lngLat;
        let requestFormat = 'application/json';
        let buffer = 50;
        let maxFeatures = 100;

        // Create a bbox of map bounds
        const bbox = [map.getBounds()._sw.lng, map.getBounds()._sw.lat, map.getBounds()._ne.lng, map.getBounds()._ne.lat]


        $.ajax(`${WMSLayer.url}?REQUEST=GetFeatureInfo&EXCEPTIONS=${requestFormat}&BBOX=${bbox.join(',')}&SERVICE=WMS&INFO_FORMAT=${requestFormat}&QUERY_LAYERS=${WMSLayer.layer}&FEATURE_COUNT=${maxFeatures}&Layers=${WMSLayer.layer}&WIDTH=${map._container.clientWidth}&HEIGHT=${map._container.clientHeight}&format=image%2Fpng&styles=&srs=EPSG%3A4326&version=1.1.1&x=${clickEvent.point.x}&y=${clickEvent.point.y}&buffer=${buffer}`).done(function(data) {
          if (console && console.log) {
            console.log("Sample of data:", data);

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(coordinates.lng - coordinates[0]) > 180) {
              coordinates[0] += coordinates.lng > coordinates[0] ? 360 : -360;
            }


            new mapboxgl.Popup()
              .setLngLat(coordinates)
              .setHTML((new TableBuilder({
                  'class': 'popup-table'
                }))
                .setHeaders({
                  mon_num: 'id',
                  monumentna: 'Name',
                  photo_img: 'Photo'
                })
                .setData(data.features.map(d => {
                  d.properties.photo_img = `<img src="http://bhuvan3.nrsc.gov.in/2dresources/asi/${d.properties.photo.toLowerCase()}" width=100>`;
                  d.properties.address = `${d.properties.location}, ${d.properties.district}, ${d.properties.state} (${d.properties.asicircle})`
                  return d.properties
                }))
                .render())
              .addTo(map);

          }
        });

      }

    </script>

  </body>

</html>
