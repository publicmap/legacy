<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Map of ancient monuments of India</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <!--     Mapbox GL JS -->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
  <!--  Mapbox Assembly CSS -->
  <link href='https://api.mapbox.com/mapbox-assembly/v0.23.1/assembly.min.css' rel='stylesheet'>
  <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.23.1/assembly.js"></script>
  <!-- Turf -->
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
  <!-- Jquery -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <!-- Table builder -->
  <script src='https://cdn.jsdelivr.net/gh/a-x-/table-builder/tablebuilder.js'></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    .mapboxgl-popup-content {
      max-width: 400px;
      max-height: 300px;
      overflow: scroll;
    }

    table img {
      max-width: inherit;
    }

    footer {
      position: absolute;
      max-height: 400px;
      bottom: 0;
      width: 100%;
      overflow: scroll;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.9);
      z-index: 100;
    }
  </style>
</head>

<body>

  <div id='map'></div>
  <footer class='prose'>
    <div id='info'>
      <div class='txt-l'>
        Monuments of National Importance in India
      </div>
      <span>Click a location to view the list of <a href="https://en.wikipedia.org/wiki/Lists_of_Indian_Monuments_of_National_Importance">
          ancient monuments</a> protected by the <a href="http://asi.nic.in/alphabetical-list-of-monuments/">Archaeological
          Survey of India (ASI)</a>. Data source: <a href="https://bhuvan-app1.nrsc.gov.in/culture_monuments/">ASI/Bhuvan</a></span>
    </div>
    <div id='feature-table'> </div>
  </footer>

  <script>
    // Configure cors-anywhere
    const cors_anywhere_url = window.location.href.indexOf('publicmap.github.io')>0? 'https://publicmap-cors-anywhere.herokuapp.com/':'https://cors-anywhere.herokuapp.com/'

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'https://cdn.jsdelivr.net/gh/mapbox/mapbox-gl-styles/styles/empty-v8.json',
      zoom: 4,
      center: [74.5447, 20.6892],
      hash: true
    });

    map.on('load', function () {

      map.addLayer({
        id: 'osm-tiles',
        type: 'raster',
        source: {
          type: 'raster',
          // Add OSM tiles: https://wiki.openstreetmap.org/wiki/Tile_servers
          tiles: [
            'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'
          ],
          tileSize: 256
        },
        paint: {
          'raster-opacity': 0.4
        }
      });

      map.addLayer({
        id: 'asi-monuments-areas',
        type: 'raster',
        source: {
          type: 'raster',
          tiles: [
            `${cors_anywhere_url}https://bhuvan5.nrsc.gov.in/bhuvan/asi/wms?STYLES=&LAYERS=asi:protected_areas&FORMAT=image/png&transparent=true&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&SRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=512&HEIGHT=512`
          ],
          tileSize: 512,
          minzoom: 10
        },
        paint: {}
      });

      map.addLayer({
        id: 'asi-monuments',
        type: 'raster',
        source: {
          type: 'raster',
          tiles: [
            `${cors_anywhere_url}https://bhuvan5.nrsc.gov.in/bhuvan/asi/wms?STYLES=&LAYERS=asi:monuments2&FORMAT=image/png&transparent=true&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&SRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256`
          ],
          tileSize: 256
        },
        paint: {}
      });

      map.addSource('feature-info', {
        type: 'geojson',
        data: 'https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_10m_ports.geojson'
      })
      map.addLayer({
        id: 'feature-info',
        type: 'circle',
        source: 'feature-info-source',
        paint: {}
      });

    });

    // Add  map UI controls
    var nav = new mapboxgl.NavigationControl();
    map.addControl(nav, 'top-left');

    map.addControl(new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      trackUserLocation: true
    }));

    var scale = new mapboxgl.ScaleControl({
      maxWidth: 80,
      unit: 'metric'
    });
    map.addControl(scale);


    map.addControl(new mapboxgl.FullscreenControl());

    // When a click event occurs on a feature in the places layer, open a popup at the
    // location of the feature, with description HTML from its properties.
    map.on('click', function (e) {

      getFeatureInfo(map, e, {
        url: `${cors_anywhere_url}https://bhuvan5.nrsc.gov.in/bhuvan/asi/wms`,
        layer: 'asi:monuments2'
      });

    });

    function getFeatureInfo(map, clickEvent, WMSLayer) {

      let coordinates = clickEvent.lngLat;
      let requestFormat = 'application/json';
      let buffer = 50;
      let maxFeatures = 100;

      // Create a bbox of map bounds
      const bbox = [map.getBounds()._sw.lng, map.getBounds()._sw.lat, map.getBounds()._ne.lng, map.getBounds()._ne.lat]


      $.ajax(
        `${WMSLayer.url}?REQUEST=GetFeatureInfo&EXCEPTIONS=${requestFormat}&BBOX=${bbox.join(',')}&SERVICE=WMS&INFO_FORMAT=${requestFormat}&QUERY_LAYERS=${WMSLayer.layer}&FEATURE_COUNT=${maxFeatures}&Layers=${WMSLayer.layer}&WIDTH=${map._container.clientWidth}&HEIGHT=${map._container.clientHeight}&format=image%2Fpng&styles=&srs=EPSG%3A4326&version=1.1.1&x=${clickEvent.point.x}&y=${clickEvent.point.y}&buffer=${buffer}`
      ).done(function (data) {
        if (console && console.log) {
          console.log("Sample of data:", data);

          // Ensure that if the map is zoomed out such that multiple
          // copies of the feature are visible, the popup appears
          // over the copy being pointed to.
          while (Math.abs(coordinates.lng - coordinates[0]) > 180) {
            coordinates[0] += coordinates.lng > coordinates[0] ? 360 : -360;
          }

          let table_HTML = (new TableBuilder({
              'class': 'popup-table'
            }))
            .setHeaders({
              mon_num: 'id',
              monumentna: 'Name',
              address: 'Location',
              photo_img: 'Photo'
            })
            .setData(data.features.map(d => {
              const img_url = `http://bhuvan3.nrsc.gov.in/2dresources/asi/${d.properties.photo.toLowerCase()}`;
              d.properties.photo_img =
                `<a href="${img_url}" target=_blank><img src="${img_url}" width=100></a>`;
              d.properties.address =
                `${d.properties.location}, ${d.properties.district}, ${d.properties.state} (${d.properties.asicircle})`
              return d.properties
            }))
            .render();

          $('#feature-table').html(table_HTML)

        }
      });

    }
  </script>

</body>

</html>